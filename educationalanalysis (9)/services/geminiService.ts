import { GoogleGenerativeAI } from "@google/generative-ai";

const apiKey = import.meta.env.VITE_GEMINI_API_KEY || "";
const genAI = new GoogleGenerativeAI(apiKey);

export const analyzeUniversityData = async (jsonString: string): Promise<{ text: string; groundingChunks?: any[] }> => {
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å Gemini 2.5 Flash, –∫–∞–∫ —Ç—ã –∏ —Ö–æ—Ç–µ–ª
  const model = genAI.getGenerativeModel({ 
    model: "gemini-2.5-flash", 
    systemInstruction: `
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã.
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å –û–ë–™–ï–ö–¢–ò–í–ù–´–ô, –ì–õ–£–ë–û–ö–ò–ô –∏ –ü–û–õ–ï–ó–ù–´–ô –æ—Ç—á–µ—Ç –æ–± —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    `
  });

  const analysisPrompt = `
    –í–æ—Ç JSON-—Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ Instagram-–∞–∫–∫–∞—É–Ω—Ç–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞:
    \`\`\`json
    ${jsonString}
    \`\`\`

    –ó–ê–î–ê–ß–ê:
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ–± —ç—Ç–æ–º —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ.
    –°–æ—Å—Ç–∞–≤—å –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –Ω–∞ –†—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
    
    –ò–°–ü–û–õ–¨–ó–£–ô MARKDOWN –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï:
    - ## –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
    - **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –≤–∞–∂–Ω–æ–≥–æ.

    –°–¢–†–£–ö–¢–£–†–ê –û–¢–ß–ï–¢–ê:

    # –ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞

    ## üìç –õ–û–ö–ê–¶–ò–Ø –ò –ö–ê–ú–ü–£–°
    ‚Äî –ì–æ—Ä–æ–¥, —Ä–∞–π–æ–Ω.
    ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã (–í–∞–π–±).

    ## üéì –û–ë–©–ê–Ø –†–ï–ü–£–¢–ê–¶–ò–Ø
    ‚Äî –†–µ–π—Ç–∏–Ω–≥ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π) –∏ –ø—Ä–µ—Å—Ç–∏–∂.

    ## üì∏ –ê–ù–ê–õ–ò–ó INSTAGRAM
    ‚Äî –û —á–µ–º –ø–∏—à—É—Ç? –ö–∞–∫–æ–π —Å—Ç–∏–ª—å?
    ‚Äî –ß—Ç–æ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å –ø–æ —Ñ–æ—Ç–æ?

    ## ‚öñÔ∏è –°–ò–õ–¨–ù–´–ï –ò –°–õ–ê–ë–´–ï –°–¢–û–†–û–ù–´
    ‚úÖ –ü–ª—é—Å—ã:
    - ...
    ‚ùå –ú–∏–Ω—É—Å—ã:
    - ...

    ## üí° –í–´–í–û–î

    --------------------------------------------------
    –í–ê–ñ–ù–û: –í –°–ê–ú–û–ú –ö–û–ù–¶–ï –û–¢–í–ï–¢–ê (–ø–æ—Å–ª–µ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞) –î–û–ë–ê–í–¨ –¢–û–õ–¨–ö–û –≠–¢–û–¢ JSON –ë–õ–û–ö:
    \`\`\`json
    {
      "sentiment_distribution": {
        "5": 60,
        "4": 20,
        "3": 10,
        "2": 5,
        "1": 5
      },
      "google_maps_rating": 4.5,
      "reviews_count": 120
    }
    \`\`\`
  `;

  try {
    const result = await model.generateContent(analysisPrompt);
    const response = await result.response;
    const text = response.text();

    return {
      text: text,
      groundingChunks: [] 
    };
  } catch (error) {
    console.error("Gemini Analysis Error:", error);
    // –í—ã–≤–æ–¥–∏–º –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –Ω–µ –Ω–∞–π–¥–µ—Ç—Å—è
    return {
      text: `–û—à–∏–±–∫–∞ API: ${error instanceof Error ? error.message : String(error)}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ –∏–ª–∏ API –∫–ª—é—á.`,
      groundingChunks: []
    };
  }
};
