import { GoogleGenAI } from "@google/genai";

// Initialize Gemini Client
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

/**
 * Performs the specific analysis requested in the prompt using the JSON data.
 */
export const analyzeUniversityData = async (jsonString: string): Promise<{ text: string; groundingChunks?: any[] }> => {
  const modelId = 'gemini-2.5-flash';

  const systemInstruction = `
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã (Senior Admissions Consultant).
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å –û–ë–™–ï–ö–¢–ò–í–ù–´–ô, –ì–õ–£–ë–û–ö–ò–ô –∏ –ü–û–õ–ï–ó–ù–´–ô –æ—Ç—á–µ—Ç –æ–± —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ.

    –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º:
    1. Google Search: –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–∫—Ç–æ–≤, —Ä–µ–π—Ç–∏–Ω–≥–æ–≤, "2-gis" –ª–æ–∫–∞—Ü–∏–π –∏ –û–¢–ó–´–í–û–í.
    2. Google Maps: –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–µ–π—Ç–∏–Ω–≥–∞.
    3. JSON-–¥–∞–Ω–Ω—ã–µ –∏–∑ Instagram: –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ "–≤–∞–π–±–∞".

    –¢–í–û–ô –ü–û–î–•–û–î:
    ‚Äî –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–π–¥–∏, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç.
    ‚Äî –û–ø–∏—à–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∫–∞–º–ø—É—Å–∞ (–Ω–∞–π–¥–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ –≤ –ø–æ–∏—Å–∫–µ).
    ‚Äî –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã —Å Instagram.
    ‚Äî –ù–∞–π–¥–∏ –æ—Ç–∑—ã–≤—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ Google Maps/Search –∏ –æ—Ü–µ–Ω–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ (5, 4, 3, 2, 1 –∑–≤–µ–∑–¥).
    ‚Äî –ï–°–õ–ò JSON —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏ (blocked/private) ‚Äî –ò–ì–ù–û–†–ò–†–£–ô –≠–¢–û. –î–µ–ª–∞–π –æ—Ç—á–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ Google Search –∏ Google Maps.
  `;

  const analysisPrompt = `
    –í–æ—Ç JSON-—Ñ–∞–π–ª —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –ø–æ—Å—Ç–∞–º–∏ Instagram-–∞–∫–∫–∞—É–Ω—Ç–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞:
    \`\`\`json
    ${jsonString}
    \`\`\`

    –ó–ê–î–ê–ß–ê:
    1. **–í–ò–ó–£–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö**: –ò—Å–ø–æ–ª—å–∑—É–π Google Search —Å –∑–∞–ø—Ä–æ—Å–æ–º "[University Name] campus photos" –∏ "[University Name] virtual tour", —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.
    2. **–õ–û–ö–ê–¶–ò–Ø –ò –û–¢–ó–´–í–´**: –í—ã–ø–æ–ª–Ω–∏ –ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É "2-gis [–ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞]" –∏ "[University Name] student reviews", —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ª–æ–∫–∞—Ü–∏—é –∏ –ß–ò–¢–ê–¢–¨ –æ—Ç–∑—ã–≤—ã.
    3. **–§–ê–ö–¢–´**: –ù–∞–π–¥–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –Ω–∞ —Å–∞–π—Ç–µ.

    –°–æ—Å—Ç–∞–≤—å –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –Ω–∞ –†—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
    –ò–°–ü–û–õ–¨–ó–£–ô MARKDOWN –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï:
    - –ò—Å–ø–æ–ª—å–∑—É–π ## –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ## üìç –õ–û–ö–ê–¶–ò–Ø –ò –ö–ê–ú–ü–£–°).
    - –ò—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç** –¥–ª—è –≤–∞–∂–Ω—ã—Ö –∞–∫—Ü–µ–Ω—Ç–æ–≤.
    - –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ —Å —Ç–∏—Ä–µ (-) –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π.

    –°–¢–†–£–ö–¢–£–†–ê –û–¢–ß–ï–¢–ê:

    # –ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞

    ## üìç –õ–û–ö–ê–¶–ò–Ø –ò –ö–ê–ú–ü–£–°
    ‚Äî –ì–æ—Ä–æ–¥, —Ä–∞–π–æ–Ω (—Ü–µ–Ω—Ç—Ä –∏–ª–∏ –æ–∫—Ä–∞–∏–Ω–∞).
    ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–º–ø—É—Å–∞ (–í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å: –°—Ç–∞—Ä–∏–Ω–Ω—ã–π/–ú–æ–¥–µ—Ä–Ω/–ó–µ–ª–µ–Ω—ã–π?).
    ‚Äî –ß—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º.

    ## üéì –û–ë–©–ê–Ø –†–ï–ü–£–¢–ê–¶–ò–Ø
    ‚Äî –°—Ç–∞—Ç—É—Å –∏ –†–µ–π—Ç–∏–Ω–≥.

    ## üèõ –¢–†–ï–ë–û–í–ê–ù–ò–Ø (–§–ê–ö–¢–´ –° –°–ê–ô–¢–ê)
    ‚Äî GPA, SAT/ACT, IELTS/TOEFL.
    ‚Äî –î–µ–¥–ª–∞–π–Ω—ã –∏ –°—Ç–æ–∏–º–æ—Å—Ç—å.

    ## üì∏ –ê–ù–ê–õ–ò–ó INSTAGRAM (–ê–¢–ú–û–°–§–ï–†–ê)
    ‚Äî (–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã): –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è.
    ‚Äî (–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–∫—Ä—ã—Ç—ã): –û–±—â–∏–π –≤–∞–π–± —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.

    ## ‚öñÔ∏è –°–ò–õ–¨–ù–´–ï –ò –°–õ–ê–ë–´–ï –°–¢–û–†–û–ù–´
    ‚úÖ –ü–ª—é—Å—ã:
    - ...
    ‚ùå –ú–∏–Ω—É—Å—ã:
    - ...

    ## üí° –í–´–í–û–î

    --------------------------------------------------
    –í–ê–ñ–ù–û: –í –°–ê–ú–û–ú –ö–û–ù–¶–ï –û–¢–í–ï–¢–ê (–ø–æ—Å–ª–µ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞) –î–û–ë–ê–í–¨ –°–õ–ï–î–£–Æ–©–ò–ô JSON –ë–õ–û–ö –° –ü–†–ò–ú–ï–†–ù–´–ú –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï–ú –û–¶–ï–ù–û–ö (–ø–æ —Ç–≤–æ–µ–π –æ—Ü–µ–Ω–∫–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤). –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100.
    
    \`\`\`json
    {
      "sentiment_distribution": {
        "5": 60,
        "4": 20,
        "3": 10,
        "2": 5,
        "1": 5
      }
    }
    \`\`\`
  `;

  const response = await ai.models.generateContent({
    model: modelId,
    contents: analysisPrompt,
    config: {
      systemInstruction: systemInstruction,
      // Enable Google Search AND Google Maps
      tools: [
        { googleSearch: {} },
        { googleMaps: {} }
      ],
    }
  });

  if (!response.text) {
    throw new Error("Failed to analyze the data.");
  }

  return {
    text: response.text,
    groundingChunks: response.candidates?.[0]?.groundingMetadata?.groundingChunks
  };
};