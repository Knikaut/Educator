import { GoogleGenerativeAI } from "@google/generative-ai";

// –í Vite –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ import.meta.env
// –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ Vercel –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è VITE_GEMINI_API_KEY
const apiKey = import.meta.env.VITE_GEMINI_API_KEY || "";

const genAI = new GoogleGenerativeAI(apiKey);

/**
 * Performs the specific analysis requested in the prompt using the JSON data.
 */
export const analyzeUniversityData = async (jsonString: string): Promise<{ text: string; groundingChunks?: any[] }> => {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é –º–æ–¥–µ–ª—å Flash
  const model = genAI.getGenerativeModel({ 
    model: "gemini-1.5-flash",
    systemInstruction: `
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã.
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å –û–ë–™–ï–ö–¢–ò–í–ù–´–ô, –ì–õ–£–ë–û–ö–ò–ô –∏ –ü–û–õ–ï–ó–ù–´–ô –æ—Ç—á–µ—Ç –æ–± —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    
    –¢–í–û–ô –ü–û–î–•–û–î:
    ‚Äî –û–ø–∏—Ä–∞–π—Å—è –Ω–∞ —Ñ–∞–∫—Ç—ã –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ JSON.
    ‚Äî –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–Ω–∞–Ω–∏—è –æ —Ä–µ–π—Ç–∏–Ω–≥–∞—Ö –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏.
    ‚Äî –û—Ü–µ–Ω–∏–≤–∞–π "–≤–∞–π–±" –ø–æ –æ–ø–∏—Å–∞–Ω–∏—è–º –ø–æ—Å—Ç–æ–≤.
    `
  });

  const analysisPrompt = `
    –í–æ—Ç JSON-—Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ Instagram-–∞–∫–∫–∞—É–Ω—Ç–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞:
    \`\`\`json
    ${jsonString}
    \`\`\`

    –ó–ê–î–ê–ß–ê:
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ–± —ç—Ç–æ–º —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ.
    –°–æ—Å—Ç–∞–≤—å –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –Ω–∞ –†—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
    
    –ò–°–ü–û–õ–¨–ó–£–ô MARKDOWN –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï:
    - ## –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
    - **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –≤–∞–∂–Ω–æ–≥–æ.

    –°–¢–†–£–ö–¢–£–†–ê –û–¢–ß–ï–¢–ê:

    # –ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞

    ## üìç –õ–û–ö–ê–¶–ò–Ø –ò –ö–ê–ú–ü–£–°
    ‚Äî –ì–æ—Ä–æ–¥, —Ä–∞–π–æ–Ω.
    ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã.

    ## üéì –û–ë–©–ê–Ø –†–ï–ü–£–¢–ê–¶–ò–Ø
    ‚Äî –†–µ–π—Ç–∏–Ω–≥ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π) –∏ –ø—Ä–µ—Å—Ç–∏–∂.

    ## üì∏ –ê–ù–ê–õ–ò–ó INSTAGRAM (–ê–¢–ú–û–°–§–ï–†–ê)
    ‚Äî –û —á–µ–º –ø–∏—à—É—Ç? –ö–∞–∫–æ–π —Å—Ç–∏–ª—å (—Å—Ç—Ä–æ–≥–∏–π –∏–ª–∏ –≤–µ—Å–µ–ª—ã–π)?
    ‚Äî –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏.

    ## ‚öñÔ∏è –°–ò–õ–¨–ù–´–ï –ò –°–õ–ê–ë–´–ï –°–¢–û–†–û–ù–´
    ‚úÖ –ü–ª—é—Å—ã:
    - ...
    ‚ùå –ú–∏–Ω—É—Å—ã:
    - ...

    ## üí° –í–´–í–û–î

    --------------------------------------------------
    –í–ê–ñ–ù–û: –í –°–ê–ú–û–ú –ö–û–ù–¶–ï –û–¢–í–ï–¢–ê (–ø–æ—Å–ª–µ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞) –î–û–ë–ê–í–¨ –¢–û–õ–¨–ö–û –≠–¢–û–¢ JSON –ë–õ–û–ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã —Å–∞–º, —Å—É–º–º–∞ 100):
    
    \`\`\`json
    {
      "sentiment_distribution": {
        "5": 60,
        "4": 20,
        "3": 10,
        "2": 5,
        "1": 5
      },
      "google_maps_rating": 4.5,
      "reviews_count": 120
    }
    \`\`\`
  `;

  try {
    const result = await model.generateContent(analysisPrompt);
    const response = await result.response;
    const text = response.text();

    return {
      text: text,
      // –í —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ SDK groundingChunks –ø—Ä–∏—Ö–æ–¥—è—Ç –∏–Ω–∞—á–µ, 
      // –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ç–∏–ø—ã
      groundingChunks: [] 
    };
  } catch (error) {
    console.error("Gemini Analysis Error:", error);
    return {
      text: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
      groundingChunks: []
    };
  }
};
